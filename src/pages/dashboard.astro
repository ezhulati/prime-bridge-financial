---
import BorrowerLayout from '../layouts/BorrowerLayout.astro';
import { createSupabaseServerClient } from '../lib/supabase';
import { formatCurrency, formatDate, applicationStatusLabels } from '../lib/utils';
import { Badge } from '../components/ui/Badge';

const user = Astro.locals.user;
if (!user) {
  return Astro.redirect('/login');
}

const supabase = createSupabaseServerClient(Astro.cookies);

// Get user's company
const { data: company } = await supabase
  .from('companies')
  .select('*')
  .eq('owner_user_id', user.id)
  .single();

// Get user's applications
const { data: applications } = await supabase
  .from('applications')
  .select('*, companies(*)')
  .order('created_at', { ascending: false });
---

<BorrowerLayout title="Dashboard">
  <div class="space-y-8">
    <!-- Welcome Section -->
    <div class="bg-white rounded-lg border border-light p-6">
      <h2 class="text-xl font-semibold text-darkest mb-2">
        Welcome back, {user.name || 'there'}!
      </h2>
      <p class="text-dark">
        {company
          ? `Manage your applications for ${company.legal_name}`
          : 'Get started by creating your company profile and submitting an application.'
        }
      </p>
    </div>

    <!-- Quick Stats -->
    <div class="grid md:grid-cols-3 gap-6">
      <div class="bg-white rounded-lg border border-light p-6">
        <p class="text-sm font-medium text-dark uppercase tracking-wide">Applications</p>
        <p class="text-3xl font-bold text-darkest mt-2">{applications?.length || 0}</p>
      </div>
      <div class="bg-white rounded-lg border border-light p-6">
        <p class="text-sm font-medium text-dark uppercase tracking-wide">Active</p>
        <p class="text-3xl font-bold text-darkest mt-2">
          {applications?.filter(a => !['funded', 'rejected'].includes(a.status)).length || 0}
        </p>
      </div>
      <div class="bg-white rounded-lg border border-light p-6">
        <p class="text-sm font-medium text-dark uppercase tracking-wide">Total Requested</p>
        <p class="text-3xl font-bold text-darkest mt-2">
          {formatCurrency(applications?.reduce((sum, a) => sum + (a.amount_requested || 0), 0) || 0)}
        </p>
      </div>
    </div>

    <!-- Applications List -->
    <div class="bg-white rounded-lg border border-light">
      <div class="p-6 border-b border-light flex items-center justify-between">
        <h3 class="text-lg font-semibold text-darkest">Your Applications</h3>
        <a
          href="/application"
          class="inline-flex items-center justify-center bg-primary text-white hover:bg-primary-hover min-h-[40px] px-5 rounded-md font-semibold no-underline text-sm"
        >
          Start new application
        </a>
      </div>

      {applications && applications.length > 0 ? (
        <div class="divide-y divide-light">
          {applications.map((app) => (
            <div class="p-6 hover:bg-lightest transition-colors">
              <div class="flex items-start justify-between gap-4">
                <div class="flex-1">
                  <div class="flex items-center gap-3 mb-2">
                    <h4 class="font-semibold text-darkest">
                      {formatCurrency(app.amount_requested)} Request
                    </h4>
                    <Badge variant={app.status as any}>
                      {applicationStatusLabels[app.status]}
                    </Badge>
                  </div>
                  <p class="text-dark text-sm line-clamp-2">{app.purpose || 'No purpose specified'}</p>
                  <p class="text-sm text-medium mt-2">
                    Created {formatDate(app.created_at)}
                  </p>
                </div>
                <div class="flex gap-2">
                  <a
                    href={`/application/status?id=${app.id}`}
                    class="text-primary text-sm font-medium underline underline-offset-2"
                  >
                    View status
                  </a>
                  {app.status === 'draft' && (
                    <a
                      href={`/application?id=${app.id}`}
                      class="text-primary text-sm font-medium underline underline-offset-2"
                    >
                      Continue
                    </a>
                  )}
                </div>
              </div>
            </div>
          ))}
        </div>
      ) : (
        <div class="p-12 text-center">
          <svg class="mx-auto h-12 w-12 text-medium" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
          </svg>
          <h4 class="mt-4 text-lg font-semibold text-darkest">No applications yet</h4>
          <p class="text-dark mt-2 max-w-sm mx-auto">
            Start your first application to begin the funding process.
          </p>
          <a
            href="/application"
            class="inline-flex items-center justify-center bg-primary text-white hover:bg-primary-hover min-h-[48px] px-6 rounded-md font-semibold no-underline text-base mt-6"
          >
            Start application
          </a>
        </div>
      )}
    </div>
  </div>
</BorrowerLayout>
