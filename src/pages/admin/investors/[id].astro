---
import AdminLayout from '../../../layouts/AdminLayout.astro';
import { createSupabaseServerClient } from '../../../lib/supabase';
import { investorTypeLabels, loanTypeLabels, riskTierLabels, formatCurrency, commitmentStatusLabels } from '../../../types/database';
import type { InvestorType, LoanType, RiskTier, CommitmentStatus } from '../../../types/database';

const { id } = Astro.params;
const user = Astro.locals.user;

if (!user || user.role !== 'admin') {
  return Astro.redirect('/login');
}

const supabase = createSupabaseServerClient(Astro.cookies);

// Get investor with user info
const { data: investor } = await supabase
  .from('investors')
  .select('*, users(name, email)')
  .eq('id', id)
  .single();

if (!investor) {
  return Astro.redirect('/admin/investors');
}

// Get investor's commitments
const { data: commitments } = await supabase
  .from('deal_commitments')
  .select('*, deals(title, status, target_yield)')
  .eq('investor_id', id)
  .order('created_at', { ascending: false });

const statusColors: Record<CommitmentStatus, string> = {
  pending: 'bg-amber-100 text-amber-700',
  confirmed: 'bg-blue-100 text-blue-700',
  funded: 'bg-green-100 text-green-700',
  withdrawn: 'bg-gray-100 text-gray-700',
  returned: 'bg-purple-100 text-purple-700',
};
---

<AdminLayout title={investor.users?.name || investor.firm_name || 'Investor'}>
  <div class="max-w-6xl mx-auto space-y-8">
    <!-- Header -->
    <div>
      <a href="/admin/investors" class="inline-flex items-center text-dark hover:text-darkest mb-4 no-underline">
        <svg class="w-4 h-4 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
        </svg>
        Back to investors
      </a>
      <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
        <div>
          <div class="flex items-center gap-3 mb-2">
            <h1 class="text-2xl font-bold text-darkest">
              {investor.users?.name || investor.firm_name || 'Unnamed Investor'}
            </h1>
            <span class={`inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold ${investor.approved ? 'bg-green-100 text-green-700' : 'bg-amber-100 text-amber-700'}`}>
              {investor.approved ? 'Approved' : 'Pending Approval'}
            </span>
            <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-medium bg-lightest text-dark">
              {investorTypeLabels[investor.investor_type as InvestorType]}
            </span>
          </div>
          <p class="text-dark">{investor.users?.email}</p>
        </div>
        <div class="flex gap-3">
          {!investor.approved && (
            <form action={`/api/admin/investors/${id}/approve`} method="POST">
              <button
                type="submit"
                class="inline-flex items-center justify-center bg-success text-white hover:bg-success/90 min-h-[48px] px-6 rounded-md font-semibold transition-colors"
              >
                Approve Investor
              </button>
            </form>
          )}
          {investor.approved && (
            <form action={`/api/admin/investors/${id}/revoke`} method="POST">
              <button
                type="submit"
                class="inline-flex items-center justify-center bg-error text-white hover:bg-error/90 min-h-[48px] px-6 rounded-md font-semibold transition-colors"
              >
                Revoke Approval
              </button>
            </form>
          )}
        </div>
      </div>
    </div>

    <!-- Stats -->
    <div class="grid md:grid-cols-4 gap-6">
      <div class="bg-white rounded-xl border border-light p-6">
        <p class="text-sm font-medium text-dark mb-1">Total Invested</p>
        <p class="text-2xl font-bold text-darkest">{formatCurrency(investor.total_invested)}</p>
      </div>
      <div class="bg-white rounded-xl border border-light p-6">
        <p class="text-sm font-medium text-dark mb-1">Total Deals</p>
        <p class="text-2xl font-bold text-darkest">{investor.total_deals}</p>
      </div>
      <div class="bg-white rounded-xl border border-light p-6">
        <p class="text-sm font-medium text-dark mb-1">Accreditation</p>
        <p class="text-2xl font-bold text-darkest capitalize">{investor.accreditation_status}</p>
      </div>
      <div class="bg-white rounded-xl border border-light p-6">
        <p class="text-sm font-medium text-dark mb-1">KYC Status</p>
        <p class="text-2xl font-bold text-darkest capitalize">{investor.kyc_status || 'Pending'}</p>
      </div>
    </div>

    <div class="grid lg:grid-cols-3 gap-8">
      <!-- Main Info -->
      <div class="lg:col-span-2 space-y-6">
        {/* Investment Criteria */}
        <div class="bg-white rounded-xl border border-light p-6">
          <h2 class="text-lg font-bold text-darkest mb-6">Investment Preferences</h2>
          <div class="grid sm:grid-cols-2 gap-6">
            <div>
              <p class="text-sm text-medium mb-1">Min Check Size</p>
              <p class="font-semibold text-darkest">{investor.min_check_size ? formatCurrency(investor.min_check_size) : 'Not set'}</p>
            </div>
            <div>
              <p class="text-sm text-medium mb-1">Max Check Size</p>
              <p class="font-semibold text-darkest">{investor.max_check_size ? formatCurrency(investor.max_check_size) : 'Not set'}</p>
            </div>
            <div>
              <p class="text-sm text-medium mb-1">Target Yield Range</p>
              <p class="font-semibold text-darkest">
                {investor.target_yield_min && investor.target_yield_max
                  ? `${investor.target_yield_min}% - ${investor.target_yield_max}%`
                  : 'Not set'}
              </p>
            </div>
            <div>
              <p class="text-sm text-medium mb-1">Preferred Duration</p>
              <p class="font-semibold text-darkest">
                {investor.preferred_duration_months?.join(', ') || 'Not set'} months
              </p>
            </div>
            <div>
              <p class="text-sm text-medium mb-1">Preferred Loan Types</p>
              <p class="font-semibold text-darkest">
                {investor.preferred_loan_types?.map((t: string) => loanTypeLabels[t as LoanType]).join(', ') || 'Any'}
              </p>
            </div>
            <div>
              <p class="text-sm text-medium mb-1">Preferred Risk Tiers</p>
              <p class="font-semibold text-darkest">
                {investor.preferred_risk_tiers?.map((t: string) => riskTierLabels[t as RiskTier]).join(', ') || 'Any'}
              </p>
            </div>
          </div>
        </div>

        {/* Accreditation */}
        <div class="bg-white rounded-xl border border-light p-6">
          <h2 class="text-lg font-bold text-darkest mb-6">Accreditation Details</h2>
          <div class="grid sm:grid-cols-2 gap-6">
            <div>
              <p class="text-sm text-medium mb-1">Status</p>
              <p class="font-semibold text-darkest capitalize">{investor.accreditation_status}</p>
            </div>
            <div>
              <p class="text-sm text-medium mb-1">Type</p>
              <p class="font-semibold text-darkest">{investor.accreditation_type || 'Not specified'}</p>
            </div>
            {investor.accreditation_verified_at && (
              <div>
                <p class="text-sm text-medium mb-1">Verified At</p>
                <p class="font-semibold text-darkest">{new Date(investor.accreditation_verified_at).toLocaleDateString()}</p>
              </div>
            )}
            {investor.accreditation_expires_at && (
              <div>
                <p class="text-sm text-medium mb-1">Expires At</p>
                <p class="font-semibold text-darkest">{new Date(investor.accreditation_expires_at).toLocaleDateString()}</p>
              </div>
            )}
            {investor.accreditation_document_url && (
              <div class="sm:col-span-2">
                <p class="text-sm text-medium mb-2">Document</p>
                <a
                  href={investor.accreditation_document_url}
                  target="_blank"
                  rel="noopener noreferrer"
                  class="inline-flex items-center gap-2 text-primary hover:underline"
                >
                  <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                  </svg>
                  View Document
                </a>
              </div>
            )}
          </div>
        </div>

        {/* Commitments */}
        <div class="bg-white rounded-xl border border-light overflow-hidden">
          <div class="p-6 border-b border-light">
            <h2 class="text-lg font-bold text-darkest">Commitments ({commitments?.length || 0})</h2>
          </div>
          {commitments && commitments.length > 0 ? (
            <div class="divide-y divide-light">
              {commitments.map((commitment) => (
                <div class="p-4 hover:bg-lightest transition-colors">
                  <div class="flex items-center justify-between gap-4">
                    <div class="min-w-0 flex-1">
                      <div class="flex items-center gap-3 mb-1">
                        <p class="font-semibold text-darkest truncate">{commitment.deals?.title}</p>
                        <span class={`inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${statusColors[commitment.status as CommitmentStatus]}`}>
                          {commitmentStatusLabels[commitment.status as CommitmentStatus]}
                        </span>
                      </div>
                      <p class="text-sm text-dark">
                        {formatCurrency(commitment.amount)} &bull; {commitment.deals?.target_yield}% target yield
                      </p>
                    </div>
                    <div class="text-right">
                      <p class="font-semibold text-success">{formatCurrency(commitment.interest_earned)}</p>
                      <p class="text-xs text-dark">Interest Earned</p>
                    </div>
                  </div>
                </div>
              ))}
            </div>
          ) : (
            <div class="p-8 text-center">
              <p class="text-dark">No commitments yet</p>
            </div>
          )}
        </div>
      </div>

      <!-- Sidebar -->
      <div class="space-y-6">
        {/* Admin Notes */}
        <div class="bg-white rounded-xl border border-light p-6">
          <h3 class="font-bold text-darkest mb-4">Admin Notes</h3>
          <form action={`/api/admin/investors/${id}/notes`} method="POST">
            <textarea
              name="admin_notes"
              rows="4"
              class="w-full px-4 py-3 rounded-md border border-light bg-white text-darkest focus:outline-none focus:ring-2 focus:ring-primary/20 focus:border-primary resize-none"
              placeholder="Add notes about this investor..."
            >{investor.admin_notes}</textarea>
            <button
              type="submit"
              class="mt-3 w-full inline-flex items-center justify-center bg-primary text-white hover:bg-primary-hover min-h-[44px] px-4 rounded-md font-semibold transition-colors"
            >
              Save Notes
            </button>
          </form>
        </div>

        {/* KYC Status */}
        <div class="bg-white rounded-xl border border-light p-6">
          <h3 class="font-bold text-darkest mb-4">KYC Status</h3>
          <form action={`/api/admin/investors/${id}/kyc`} method="POST">
            <select
              name="kyc_status"
              class="w-full min-h-[44px] px-4 rounded-md border border-light bg-white text-darkest focus:outline-none focus:ring-2 focus:ring-primary/20 focus:border-primary"
            >
              <option value="pending" selected={investor.kyc_status === 'pending'}>Pending</option>
              <option value="passed" selected={investor.kyc_status === 'passed'}>Passed</option>
              <option value="failed" selected={investor.kyc_status === 'failed'}>Failed</option>
              <option value="review" selected={investor.kyc_status === 'review'}>Needs Review</option>
            </select>
            <button
              type="submit"
              class="mt-3 w-full inline-flex items-center justify-center bg-primary text-white hover:bg-primary-hover min-h-[44px] px-4 rounded-md font-semibold transition-colors"
            >
              Update KYC
            </button>
          </form>
        </div>

        {/* Timeline */}
        <div class="bg-white rounded-xl border border-light p-6">
          <h3 class="font-bold text-darkest mb-4">Timeline</h3>
          <div class="space-y-4">
            <div class="flex gap-3">
              <div class="w-2 h-2 rounded-full bg-success mt-2"></div>
              <div>
                <p class="text-sm font-medium text-darkest">Registered</p>
                <p class="text-xs text-medium">{new Date(investor.created_at).toLocaleDateString()}</p>
              </div>
            </div>
            {investor.kyc_completed_at && (
              <div class="flex gap-3">
                <div class="w-2 h-2 rounded-full bg-blue-500 mt-2"></div>
                <div>
                  <p class="text-sm font-medium text-darkest">KYC Completed</p>
                  <p class="text-xs text-medium">{new Date(investor.kyc_completed_at).toLocaleDateString()}</p>
                </div>
              </div>
            )}
            {investor.approved_at && (
              <div class="flex gap-3">
                <div class="w-2 h-2 rounded-full bg-green-500 mt-2"></div>
                <div>
                  <p class="text-sm font-medium text-darkest">Approved</p>
                  <p class="text-xs text-medium">{new Date(investor.approved_at).toLocaleDateString()}</p>
                </div>
              </div>
            )}
          </div>
        </div>
      </div>
    </div>
  </div>
</AdminLayout>
