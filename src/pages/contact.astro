---
import BaseLayout from '../layouts/BaseLayout.astro';
import Header from '../components/layout/Header.astro';
import Footer from '../components/layout/Footer.astro';
import { getAuthUser } from '../lib/auth';

const authUser = await getAuthUser(Astro.cookies);
---

<BaseLayout
  title="Contact Us"
  description="Get in touch with the PrimeBridge team. Questions about loan tape validation, covenant monitoring, or enterprise pricing? We're here to help."
  image="/PrimeBridge_Finance.jpg"
>
  <Header user={authUser?.user} />

  <main class="py-20 lg:py-24 bg-white">
    <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8">
      <div class="grid lg:grid-cols-2 gap-12 lg:gap-16">
        <!-- Contact Info -->
        <div>
          <p class="text-primary font-semibold tracking-widest uppercase text-sm mb-6">
            Get in Touch
          </p>
          <h1 class="text-4xl lg:text-5xl font-black text-darkest leading-[1.15] tracking-tight mb-8">
            Contact PrimeBridge
          </h1>
          <p class="text-lg text-dark leading-relaxed mb-8" style="max-width: 50ch;">
            Have questions about loan tape validation, covenant monitoring, or enterprise features? Our team is here to help.
          </p>

          <div class="space-y-6">
            <div class="flex gap-4">
              <div class="w-12 h-12 rounded-xl bg-primary/10 flex items-center justify-center flex-shrink-0">
                <svg class="w-6 h-6 text-primary" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
              </div>
              <div>
                <h3 class="font-semibold text-darkest">Product Questions</h3>
                <p class="text-dark mt-1">Learn about tape validation, column mapping, validation rules, and exporting clean data.</p>
              </div>
            </div>

            <div class="flex gap-4">
              <div class="w-12 h-12 rounded-xl bg-primary/10 flex items-center justify-center flex-shrink-0">
                <svg class="w-6 h-6 text-primary" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                </svg>
              </div>
              <div>
                <h3 class="font-semibold text-darkest">Covenant Monitoring</h3>
                <p class="text-dark mt-1">Questions about tracking DSCR, delinquency rates, and getting alerts before breaches.</p>
              </div>
            </div>

            <div class="flex gap-4">
              <div class="w-12 h-12 rounded-xl bg-primary/10 flex items-center justify-center flex-shrink-0">
                <svg class="w-6 h-6 text-primary" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" />
                </svg>
              </div>
              <div>
                <h3 class="font-semibold text-darkest">Enterprise & Integrations</h3>
                <p class="text-dark mt-1">Custom validation rules, API access, LMS integrations, and dedicated support.</p>
              </div>
            </div>
          </div>

          <div class="mt-10 p-6 bg-lightest rounded-xl border border-light">
            <h4 class="font-semibold text-darkest mb-2">Response Time</h4>
            <p class="text-dark text-sm">We typically respond within 1 business day. For urgent matters, please indicate in your message.</p>
          </div>
        </div>

        <!-- Contact Form -->
        <div>
          <div class="bg-lightest rounded-2xl border border-light p-8 lg:p-10">
            <h2 class="text-2xl font-bold text-darkest mb-8">Send us a message</h2>

            <!-- Success Message -->
            <div id="success-message" class="hidden">
              <div class="text-center py-8">
                <div class="w-16 h-16 rounded-full bg-green-100 flex items-center justify-center mx-auto mb-6">
                  <svg class="w-8 h-8 text-green-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                  </svg>
                </div>
                <h3 class="text-xl font-bold text-darkest mb-2">Message sent</h3>
                <p class="text-dark mb-6">We'll get back to you within 1 business day.</p>
                <button
                  type="button"
                  id="send-another"
                  class="text-primary font-medium underline underline-offset-2 hover:text-primary-hover"
                >
                  Send another message
                </button>
              </div>
            </div>

            <!-- Error Message -->
            <div id="error-message" class="hidden mb-6 p-4 bg-red-50 border border-red-200 rounded-lg">
              <div class="flex gap-3">
                <svg class="w-5 h-5 text-red-600 flex-shrink-0 mt-0.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                <p id="error-text" class="text-red-700 text-sm"></p>
              </div>
            </div>

            <form id="contact-form" class="space-y-6">
              <p class="hidden">
                <label>Don't fill this out: <input name="bot-field" /></label>
              </p>

              <div>
                <label for="name" class="block text-sm font-medium text-darkest mb-2">
                  Full name <span class="text-error">*</span>
                </label>
                <input
                  type="text"
                  id="name"
                  name="name"
                  required
                  class="w-full min-h-[48px] px-4 rounded-md border border-medium bg-white text-darkest placeholder:text-medium focus:outline-none focus:ring-2 focus:ring-primary/20 focus:border-primary"
                  placeholder="Your name"
                />
              </div>

              <div>
                <label for="email" class="block text-sm font-medium text-darkest mb-2">
                  Email address <span class="text-error">*</span>
                </label>
                <input
                  type="email"
                  id="email"
                  name="email"
                  required
                  class="w-full min-h-[48px] px-4 rounded-md border border-medium bg-white text-darkest placeholder:text-medium focus:outline-none focus:ring-2 focus:ring-primary/20 focus:border-primary"
                  placeholder="you@company.com"
                />
              </div>

              <div>
                <label for="type" class="block text-sm font-medium text-darkest mb-2">
                  What can we help with? <span class="text-error">*</span>
                </label>
                <select
                  id="type"
                  name="type"
                  required
                  class="w-full min-h-[48px] px-4 rounded-md border border-medium bg-white text-darkest focus:outline-none focus:ring-2 focus:ring-primary/20 focus:border-primary"
                >
                  <option value="">Select one</option>
                  <option value="product">Product questions</option>
                  <option value="enterprise">Enterprise pricing</option>
                  <option value="integration">API / Integration</option>
                  <option value="support">Technical support</option>
                  <option value="other">Other</option>
                </select>
              </div>

              <div>
                <label for="company" class="block text-sm font-medium text-darkest mb-2">
                  Company <span class="text-dark text-xs">(optional)</span>
                </label>
                <input
                  type="text"
                  id="company"
                  name="company"
                  class="w-full min-h-[48px] px-4 rounded-md border border-medium bg-white text-darkest placeholder:text-medium focus:outline-none focus:ring-2 focus:ring-primary/20 focus:border-primary"
                  placeholder="Your company name"
                />
              </div>

              <div>
                <label for="message" class="block text-sm font-medium text-darkest mb-2">
                  Message <span class="text-error">*</span>
                </label>
                <textarea
                  id="message"
                  name="message"
                  rows="5"
                  required
                  class="w-full px-4 py-3 rounded-md border border-medium bg-white text-darkest placeholder:text-medium focus:outline-none focus:ring-2 focus:ring-primary/20 focus:border-primary resize-none"
                  placeholder="Tell us about your loan tape workflow and what you're looking for..."
                ></textarea>
              </div>

              <button
                type="submit"
                id="submit-button"
                class="w-full inline-flex items-center justify-center bg-primary text-white hover:bg-primary-hover min-h-[52px] px-8 rounded-lg font-semibold text-lg transition-colors"
              >
                <span id="button-text">Send message</span>
                <svg id="button-spinner" class="hidden animate-spin ml-2 h-5 w-5 text-white" fill="none" viewBox="0 0 24 24">
                  <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                  <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
              </button>

              <p class="text-xs text-dark text-center">
                By submitting this form, you agree to our <a href="/privacy" class="text-primary underline">Privacy Policy</a>.
              </p>
            </form>
          </div>
        </div>
      </div>
    </div>
  </main>

  <Footer />

  <script>
    const form = document.getElementById('contact-form') as HTMLFormElement;
    const successMessage = document.getElementById('success-message');
    const errorMessage = document.getElementById('error-message');
    const errorText = document.getElementById('error-text');
    const submitButton = document.getElementById('submit-button') as HTMLButtonElement;
    const buttonText = document.getElementById('button-text');
    const buttonSpinner = document.getElementById('button-spinner');
    const sendAnother = document.getElementById('send-another');

    function setLoading(loading: boolean) {
      if (loading) {
        submitButton.disabled = true;
        buttonText?.classList.add('opacity-50');
        buttonSpinner?.classList.remove('hidden');
      } else {
        submitButton.disabled = false;
        buttonText?.classList.remove('opacity-50');
        buttonSpinner?.classList.add('hidden');
      }
    }

    function showError(message: string) {
      if (errorText) errorText.textContent = message;
      errorMessage?.classList.remove('hidden');
    }

    function hideError() {
      errorMessage?.classList.add('hidden');
    }

    function showSuccess() {
      form?.classList.add('hidden');
      successMessage?.classList.remove('hidden');
      hideError();
    }

    function resetForm() {
      form?.reset();
      form?.classList.remove('hidden');
      successMessage?.classList.add('hidden');
      hideError();
    }

    sendAnother?.addEventListener('click', resetForm);

    form?.addEventListener('submit', async (e) => {
      e.preventDefault();
      hideError();
      setLoading(true);

      try {
        const formData = new FormData(form);

        const response = await fetch('/api/contact', {
          method: 'POST',
          body: formData,
        });

        const result = await response.json();

        if (result.success) {
          showSuccess();
        } else {
          showError(result.error || 'Failed to send message. Please try again.');
        }
      } catch (error) {
        showError('An unexpected error occurred. Please try again.');
      } finally {
        setLoading(false);
      }
    });
  </script>
</BaseLayout>
