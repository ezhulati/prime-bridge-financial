---
import BaseLayout from '../../layouts/BaseLayout.astro';
import Header from '../../components/layout/Header.astro';
import Footer from '../../components/layout/Footer.astro';
import { getAuthUser } from '../../lib/auth';
import { supabase } from '../../lib/supabase';

const authUser = await getAuthUser(Astro.cookies);

// Redirect if not logged in or not an investor
if (!authUser?.user || authUser.user.role !== 'investor') {
  return Astro.redirect('/login');
}

// Get investor profile
const { data: investor } = await supabase
  .from('investors')
  .select('*')
  .eq('user_id', authUser.user.id)
  .single();
---

<BaseLayout
  title="My Profile | PrimeBridge Finance"
  description="Manage your investor profile and accreditation status."
>
  <Header user={authUser?.user} />

  <main class="py-12 lg:py-16 bg-lightest min-h-screen">
    <div class="mx-auto max-w-4xl px-4 sm:px-6 lg:px-8">
      <!-- Header -->
      <div class="mb-8">
        <nav class="text-sm mb-4">
          <a href="/investor/dashboard" class="text-primary hover:underline">Dashboard</a>
          <span class="text-dark mx-2">/</span>
          <span class="text-dark">Profile</span>
        </nav>
        <h1 class="text-3xl font-bold text-darkest">My Profile</h1>
      </div>

      <div class="space-y-6">
        <!-- Account Information -->
        <section class="bg-white rounded-xl border border-light p-6 lg:p-8">
          <h2 class="text-xl font-bold text-darkest mb-6">Account Information</h2>
          <div class="grid md:grid-cols-2 gap-6">
            <div>
              <label class="block text-sm font-medium text-dark mb-1">Full Name</label>
              <p class="text-darkest font-medium">{authUser.user.full_name || 'Not provided'}</p>
            </div>
            <div>
              <label class="block text-sm font-medium text-dark mb-1">Email</label>
              <p class="text-darkest font-medium">{authUser.user.email}</p>
            </div>
            <div>
              <label class="block text-sm font-medium text-dark mb-1">Account Type</label>
              <p class="text-darkest font-medium capitalize">{authUser.user.role}</p>
            </div>
            <div>
              <label class="block text-sm font-medium text-dark mb-1">Member Since</label>
              <p class="text-darkest font-medium">
                {new Date(authUser.user.created_at).toLocaleDateString('en-US', {
                  month: 'long',
                  year: 'numeric'
                })}
              </p>
            </div>
          </div>
        </section>

        <!-- Investor Profile -->
        {investor && (
          <section class="bg-white rounded-xl border border-light p-6 lg:p-8">
            <h2 class="text-xl font-bold text-darkest mb-6">Investor Profile</h2>
            <div class="grid md:grid-cols-2 gap-6">
              <div>
                <label class="block text-sm font-medium text-dark mb-1">Investor Type</label>
                <p class="text-darkest font-medium capitalize">{investor.investor_type?.replace('_', ' ') || 'Not specified'}</p>
              </div>
              <div>
                <label class="block text-sm font-medium text-dark mb-1">Accreditation Status</label>
                <span class={`inline-flex items-center px-2.5 py-0.5 rounded-full text-sm font-medium ${
                  investor.accreditation_status === 'verified'
                    ? 'bg-success/10 text-success'
                    : investor.accreditation_status === 'pending'
                    ? 'bg-warning/10 text-warning'
                    : 'bg-dark/10 text-dark'
                }`}>
                  {investor.accreditation_status || 'Not verified'}
                </span>
              </div>
              {investor.company_name && (
                <div>
                  <label class="block text-sm font-medium text-dark mb-1">Company/Entity</label>
                  <p class="text-darkest font-medium">{investor.company_name}</p>
                </div>
              )}
              <div>
                <label class="block text-sm font-medium text-dark mb-1">Investment Range</label>
                <p class="text-darkest font-medium">
                  {investor.min_investment && investor.max_investment
                    ? `$${(investor.min_investment / 1000).toFixed(0)}K - $${(investor.max_investment / 1000000).toFixed(1)}M`
                    : 'Not specified'}
                </p>
              </div>
            </div>

            {investor.investment_preferences && (
              <div class="mt-6">
                <label class="block text-sm font-medium text-dark mb-2">Investment Preferences</label>
                <div class="flex flex-wrap gap-2">
                  {investor.investment_preferences.map((pref: string) => (
                    <span class="px-3 py-1 bg-primary/10 text-primary text-sm rounded-full">
                      {pref}
                    </span>
                  ))}
                </div>
              </div>
            )}
          </section>
        )}

        <!-- KYC Status -->
        <section class="bg-white rounded-xl border border-light p-6 lg:p-8">
          <div class="flex items-start justify-between">
            <div>
              <h2 class="text-xl font-bold text-darkest mb-2">Identity Verification</h2>
              <p class="text-dark">
                {investor?.kyc_status === 'verified'
                  ? 'Your identity has been verified.'
                  : 'Complete identity verification to access all platform features.'}
              </p>
            </div>
            {investor?.kyc_status === 'verified' ? (
              <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-medium bg-success/10 text-success">
                <svg class="w-4 h-4 mr-1.5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" />
                </svg>
                Verified
              </span>
            ) : (
              <a
                href="/investor/dashboard"
                class="inline-flex items-center justify-center bg-primary text-white hover:bg-primary-hover min-h-[48px] px-5 rounded-lg font-semibold no-underline text-sm"
              >
                Verify Identity
              </a>
            )}
          </div>
        </section>

        <!-- Quick Links -->
        <section class="bg-white rounded-xl border border-light p-6 lg:p-8">
          <h2 class="text-xl font-bold text-darkest mb-6">Quick Links</h2>
          <div class="grid sm:grid-cols-2 lg:grid-cols-3 gap-4">
            <a href="/investor/deals" class="flex items-center gap-3 p-4 bg-lightest rounded-lg hover:bg-light transition-colors">
              <div class="w-10 h-10 rounded-lg bg-primary/10 flex items-center justify-center">
                <svg class="w-5 h-5 text-primary" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" />
                </svg>
              </div>
              <span class="font-medium text-darkest">Browse Deals</span>
            </a>
            <a href="/investor/portfolio" class="flex items-center gap-3 p-4 bg-lightest rounded-lg hover:bg-light transition-colors">
              <div class="w-10 h-10 rounded-lg bg-primary/10 flex items-center justify-center">
                <svg class="w-5 h-5 text-primary" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                </svg>
              </div>
              <span class="font-medium text-darkest">My Portfolio</span>
            </a>
            <a href="/investor/settings" class="flex items-center gap-3 p-4 bg-lightest rounded-lg hover:bg-light transition-colors">
              <div class="w-10 h-10 rounded-lg bg-primary/10 flex items-center justify-center">
                <svg class="w-5 h-5 text-primary" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                  <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                </svg>
              </div>
              <span class="font-medium text-darkest">Settings</span>
            </a>
          </div>
        </section>
      </div>
    </div>
  </main>

  <Footer />
</BaseLayout>
